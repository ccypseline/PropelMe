cat > App/Routers/Auth.py << 'EOF'
from fastapi import APIRouter, HTTPException, Query
from typing import Optional
import secrets
from ..oauth.linkedin import LinkedInOAuth
from ..Config import settings

router = APIRouter(prefix="/auth", tags=["Authentication"])

# Store state tokens (in production, use Redis or database)
_state_tokens = {}

linkedin_oauth = LinkedInOAuth()

@router.get("/linkedin/login")
async def linkedin_login():
    """Initiate LinkedIn OAuth flow"""
    
    if not settings.linkedin_client_id:
        raise HTTPException(
            status_code=501,
            detail="LinkedIn OAuth not configured. Set LINKEDIN_CLIENT_ID and LINKEDIN_CLIENT_SECRET in environment."
        )
    
    # Generate secure state token
    state = secrets.token_urlsafe(32)
    _state_tokens[state] = True
    
    auth_url = linkedin_oauth.get_authorization_url(state)
    
    return {
        "authorization_url": auth_url,
        "state": state,
        "instructions": "Redirect user to authorization_url"
    }

@router.get("/linkedin/callback")
async def linkedin_callback(
    code: Optional[str] = None,
    state: Optional[str] = None,
    error: Optional[str] = None,
    error_description: Optional[str] = None
):
    """Handle LinkedIn OAuth callback"""
    
    if error:
        raise HTTPException(
            status_code=400,
            detail=f"LinkedIn auth error: {error} - {error_description}"
        )
    
    if not code or not state:
        raise HTTPException(
            status_code=400,
            detail="Missing code or state parameter"
        )
    
    # Verify state token
    if state not in _state_tokens:
        raise HTTPException(
            status_code=400,
            detail="Invalid state token"
        )
    
    # Remove used state token
    del _state_tokens[state]
    
    # Exchange code for token
    token_data = await linkedin_oauth.exchange_code_for_token(code)
    
    # Get user profile
    profile = await linkedin_oauth.get_user_profile(token_data["access_token"])
    
    return {
        "status": "success",
        "profile": profile,
        "access_token": token_data["access_token"],
        "expires_in": token_data.get("expires_in")
    }

@router.get("/linkedin/profile")
async def get_linkedin_profile(access_token: str = Query(...)):
    """Get LinkedIn profile using access token"""
    
    profile = await linkedin_oauth.get_user_profile(access_token)
    return {"status": "success", "profile": profile}

@router.get("/linkedin/connections")
async def get_linkedin_connections(access_token: str = Query(...)):
    """Get LinkedIn connections (requires partner API access)"""
    
    connections = await linkedin_oauth.get_connections(access_token)
    return {"status": "success", "data": connections}
EOF
