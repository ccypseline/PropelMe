from fastapi import APIRouter, Depends, HTTPException
from typing import List
import asyncpg

from app.db import get_db
from app.schemas import Contact, ContactCreate

router = APIRouter(prefix="/contacts", tags=["contacts"])

@router.get("/", response_model=List[Contact])
async def list_contacts(db: asyncpg.Connection = Depends(get_db)):
    rows = await db.fetch("""
        SELECT id, name, email, linkedin_url AS linkedin_url,
               company, title, location,
               COALESCE(warmth_score, 0) AS warmth_score,
               COALESCE(warmth_bucket, 'cold') AS warmth_bucket,
               COALESCE(relevance_score, 0) AS relevance_score,
               COALESCE(relevance_bucket, 'low') AS relevance_bucket
        FROM contacts
        ORDER BY id DESC
        LIMIT 100;
    """)
    return [dict(r) for r in rows]

@router.post("/", response_model=Contact)
async def create_contact(
    contact: ContactCreate,
    db: asyncpg.Connection = Depends(get_db)
):
    row = await db.fetchrow("""
        INSERT INTO contacts (name, email, linkedin_url, company, title, location)
        VALUES ($1, $2, $3, $4, $5, $6)
        RETURNING id, name, email, linkedin_url,
                  company, title, location,
                  COALESCE(warmth_score, 0) AS warmth_score,
                  COALESCE(warmth_bucket, 'cold') AS warmth_bucket,
                  COALESCE(relevance_score, 0) AS relevance_score,
                  COALESCE(relevance_bucket, 'low') AS relevance_bucket;
    """, contact.name, contact.email, contact.linkedin_url,
         contact.company, contact.title, contact.location)
    return dict(row)
